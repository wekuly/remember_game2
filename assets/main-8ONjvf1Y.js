(function(){const c=document.createElement("link").relList;if(c&&c.supports&&c.supports("modulepreload"))return;for(const f of document.querySelectorAll('link[rel="modulepreload"]'))d(f);new MutationObserver(f=>{for(const h of f)if(h.type==="childList")for(const L of h.addedNodes)L.tagName==="LINK"&&L.rel==="modulepreload"&&d(L)}).observe(document,{childList:!0,subtree:!0});function v(f){const h={};return f.integrity&&(h.integrity=f.integrity),f.referrerPolicy&&(h.referrerPolicy=f.referrerPolicy),f.crossOrigin==="use-credentials"?h.credentials="include":f.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function d(f){if(f.ep)return;f.ep=!0;const h=v(f);fetch(f.href,h)}})();function Oe(){const i=window;if(!i.io)throw new Error("Socket.IO not loaded. Check index.html script order.");return i.io}function _e(){l||(l=Oe()(G,{path:"/socket.io",transports:["websocket","polling"]}),l.on("connect",()=>{const i=re()?.name??"";l?.emit("login",{name:i||void 0})}))}const G="https://remembergame2-production.up.railway.app",pe="remember_game2_user",ue="remember_game2_room",Ke=3e3,Ye=2e3,ce=30,ze=60,Qe="",ne=10;let _=null,N=null,l=null;function te(i){const c=document.createElement("div");return c.textContent=i,c.innerHTML}function ge(){const i=document.getElementById("app");if(!i)throw new Error("#app not found");return i}function re(){try{const i=localStorage.getItem(pe);if(!i)return null;const c=JSON.parse(i);if(c&&typeof c=="object"&&"name"in c&&typeof c.name=="string")return c}catch{}return null}function Xe(i){const c={id:`local_${Date.now()}_${Math.random().toString(36).slice(2,9)}`,name:i};return localStorage.setItem(pe,JSON.stringify(c)),c}function qe(){try{const i=sessionStorage.getItem(ue);if(!i)return null;const c=JSON.parse(i);if(c&&typeof c=="object"&&"roomId"in c&&"playerIndex"in c)return c}catch{}return null}function we(i,c,v){sessionStorage.setItem(ue,JSON.stringify({roomId:i,playerIndex:c,plateCount:v}))}function ye(){sessionStorage.removeItem(ue)}function ae(){return(re()?.name??"").trim()||"플레이어"}async function Ze(){try{const c=await(await fetch(`${G}/api/rooms`)).json();return c.ok&&Array.isArray(c.rooms)?c.rooms:[]}catch{return[]}}async function et(i){const c=ae(),d=await(await fetch(`${G}/api/rooms`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({plateCount:i,creatorName:c})})).json();if(!d.ok||!d.roomId)throw new Error(d.error??"방 생성에 실패했습니다.");const f=d.room?.plateCount??i;return{roomId:d.roomId,plateCount:f}}async function $e(i,c){const d=await(await fetch(`${G}/api/rooms/${encodeURIComponent(i)}/join`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({playerName:c})})).json();if(!d.ok||d.playerIndex===void 0)throw new Error(d.error??"방 참가에 실패했습니다.");return{playerIndex:d.playerIndex,room:d.room??null}}async function tt(i,c){const d=await(await fetch(`${G}/api/rooms/${encodeURIComponent(i)}/leave`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({playerIndex:c})})).json();if(!d.ok)throw new Error(d.error??"방 나가기에 실패했습니다.")}async function Ne(i){try{const v=await(await fetch(`${G}/api/rooms/${encodeURIComponent(i)}`)).json();return v.ok&&v.room?v.room:null}catch{return null}}function de(){_&&(clearInterval(_),_=null),N&&(clearInterval(N),N=null);const i=ge();i.innerHTML=`
    <main class="login-wrap">
      <h1 class="login-title">remember_game2</h1>
      <p class="login-desc">1:1 온라인 게임</p>
      <form id="loginForm" class="login-form" novalidate>
        <label for="nickname" class="sr-only">닉네임</label>
        <input type="text" id="nickname" name="nickname" class="login-input" placeholder="닉네임 입력" minlength="2" maxlength="12" autocomplete="username" required />
        <span id="nicknameError" class="login-error" aria-live="polite"></span>
        <button type="submit" class="login-btn" id="loginBtn">로그인</button>
      </form>
      <p class="login-foot">현재 로컬 스토리지 저장 · 추후 DB 연동 예정</p>
    </main>
  `;const c=document.getElementById("loginForm"),v=document.getElementById("nickname"),d=document.getElementById("nicknameError"),f=document.getElementById("loginBtn");c.addEventListener("submit",h=>{h.preventDefault(),d.textContent="",v.classList.remove("invalid");const L=v.value.trim();if(L.length<2){d.textContent="닉네임은 2자 이상 입력해 주세요.",v.classList.add("invalid"),v.focus();return}if(L.length>12){d.textContent="닉네임은 12자 이하로 입력해 주세요.",v.classList.add("invalid");return}f.disabled=!0,Xe(L),_e(),l?.emit("login",{name:L}),oe()})}function oe(){N&&(clearInterval(N),N=null);const i=re();if(!i){de();return}const c=ge(),v=[10,12,14,16,18,20];c.innerHTML=`
    <main class="login-wrap lobby-wrap">
      <h1 class="login-title">로비</h1>
      <p class="login-desc">방을 만들거나 참가할 수 있습니다</p>
      <div class="lobby-user" id="userInfo">로그인됨: <strong>${te(i.name)}</strong></div>
      <section class="lobby-section lobby-section-create">
        <div class="lobby-plate-row">
          <label for="plateCountSelect" class="lobby-label">접시 개수</label>
          <select id="plateCountSelect" class="lobby-select" aria-describedby="plateCountHint">
            ${v.map(x=>`<option value="${x}">${x}개</option>`).join("")}
          </select>
        </div>
        <span id="plateCountHint" class="lobby-hint">방 만들 때 사용됩니다 (10~20개, 2단위)</span>
        <button type="button" class="lobby-btn primary" id="createRoomBtn">방 만들기</button>
      </section>
      <section class="lobby-section">
        <h2 class="lobby-section-title">참가 가능한 방</h2>
        <div id="roomList" class="room-list">불러오는 중…</div>
        <p class="lobby-hint" id="roomListHint">다른 사용자가 만든 방이 여기 표시됩니다</p>
      </section>
      <button type="button" class="logout-btn" id="logoutBtn">로그아웃</button>
    </main>
  `;const d=document.getElementById("createRoomBtn"),f=document.getElementById("logoutBtn"),h=document.getElementById("roomList"),L=document.getElementById("roomListHint");f.addEventListener("click",()=>{localStorage.removeItem(pe),ye(),de()}),d.addEventListener("click",async()=>{d.disabled=!0;const x=document.getElementById("plateCountSelect"),p=x?Math.min(20,Math.max(10,parseInt(x.value,10)||10)):10;try{const{roomId:E,plateCount:y}=await et(p),$=ae(),{playerIndex:O}=await $e(E,$);we(E,O,y),me()}catch(E){alert(E instanceof Error?E.message:"방 생성에 실패했습니다."),d.disabled=!1}});function a(){Ze().then(x=>{if(!(!h||!L)){if(x.length===0){h.innerHTML='<p class="lobby-hint">참가 가능한 방이 없습니다.</p>',L.textContent="방 만들기 후 다른 사용자가 여기서 참가할 수 있습니다.";return}L.textContent="",h.innerHTML=x.map(p=>{const E=p.player1?.name??"대기 중",y=p.plateCount??ne;return`
            <div class="room-item">
              <div>
                <span class="room-item-player">${te(E)} 대기 중</span>
                <span class="room-item-plates">접시 ${y}개</span>
              </div>
              <button type="button" class="lobby-btn join" data-room-id="${te(p.id)}">참가</button>
            </div>
          `}).join(""),h.querySelectorAll(".lobby-btn.join").forEach(p=>{p.addEventListener("click",async()=>{const E=p.dataset.roomId;if(E){p.disabled=!0;try{const y=ae(),{playerIndex:$,room:O}=await $e(E,y),T=O?.plateCount??ne;we(E,$,T),me()}catch(y){alert(y instanceof Error?y.message:"참가에 실패했습니다."),p.disabled=!1}}})})}}).catch(()=>{h&&(h.textContent="방 목록을 불러올 수 없습니다.")})}a(),_&&clearInterval(_),_=setInterval(a,Ke)}function me(){_&&(clearInterval(_),_=null);const i=qe();if(!i){oe();return}const c=ge(),v=Math.min(20,Math.max(10,i.plateCount??ne)),d=Math.min(10,Math.floor(v/2)),f=d*(d-1)/2,h=Array.from({length:d},()=>'<span class="player-token player-token--p1" aria-hidden="true"></span>').join(""),L=Array.from({length:d},()=>'<span class="player-token player-token--p2" aria-hidden="true"></span>').join("");c.innerHTML=`
    <main class="login-wrap game-wrap" id="gameWrap">
      <h1 class="login-title">기억의 만찬</h1>
      <div id="gameRoom" class="game-room">
        <div id="roomPlayers" class="game-room-players">
          <div class="player-slot" data-slot="0">
            <span class="player-label">1P</span>
            <div class="player-info">
              <span class="player-name"></span>
              <span class="player-badge" aria-hidden="true">나</span>
            </div>
            <div class="player-tokens">${h}</div>
          </div>
          <span class="game-room-vs" aria-hidden="true">VS</span>
          <div class="player-slot" data-slot="1">
            <span class="player-label">2P</span>
            <div class="player-info">
              <span class="player-name"></span>
              <span class="player-badge" aria-hidden="true">나</span>
            </div>
            <div class="player-tokens">${L}</div>
          </div>
        </div>
      </div>
      <div id="gameArea" class="game-area">
        <div class="game-area-token-label game-area-token-label--p1" aria-hidden="true"><span class="player-token player-token--p1" aria-hidden="true"></span> x <span class="game-area-token-n">${f}</span></div>
        <div class="game-area-token-label game-area-token-label--p2" aria-hidden="true"><span class="player-token player-token--p2" aria-hidden="true"></span> x <span class="game-area-token-n">${f}</span></div>
        <div id="gameAreaContent"></div>
      </div>
      <button type="button" class="logout-btn" id="backToLobbyBtn">나가기</button>
    </main>
  `;const a=i;let x="ready",p=0,E=0,y=null,$=ce;const O=new Set,T={};let z=0,fe=0,P=!1,k=!1,H="round";const C=[];let F="selectTwoPlates",D=null,J=f,W=f,M=d,A=d;const V=2e3;function le(e){const n=Math.floor(e/60),t=e%60;return`${n.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`}const Q=Math.min(20,Math.max(10,a.plateCount??ne));function He(e){const n=document.getElementById("gameNotice");n&&n.remove();const t=document.createElement("div");t.id="gameNotice",t.className="game-notice",t.setAttribute("role","alert"),t.textContent=e,document.body.appendChild(t),setTimeout(()=>t.remove(),2500)}const X=Math.floor(Q/2)-1;function Ie(e){return e===1-E}const De=3e3;let U=!1;const he=a.playerIndex===0;l||(l=Oe()(G,{path:"/socket.io",transports:["websocket","polling"]})),l.emit("game:joinRoom",{roomId:a.roomId,playerIndex:a.playerIndex,playerName:ae()});const ve=e=>{e?.roomId===a.roomId&&(x="playing",$=ce,Pe(),Ne(a.roomId).then(t=>{t&&Be(t)}))};l.on("game:start",ve);function se(e){if(y&&(clearInterval(y),y=null),N&&(clearInterval(N),N=null),l&&l.off("room:playerLeft",xe),l&&l.off("game:start",ve),l&&l.off("game:plateClick",Se),l&&l.off("game:mainTwoPlatesSelected"),l&&l.off("game:mainTokenPlaced"),l&&l.off("game:mainWrongAnswerDone"),l&&l.off("game:mainTimeOver"),l&&l.off("game:turnSwitch",Te),l&&l.off("game:gameOver",Le),l&&l.off("game:roomClosed",Ce),e.emitSocketLeave&&l?.emit("room:leave",{roomId:a.roomId,playerIndex:a.playerIndex}),e.skipEmitAndApi||tt(a.roomId,a.playerIndex).catch(()=>{}),ye(),e.showOpponentLeftAlert&&alert("상대가 방을 나갔습니다."),oe(),e.reenableBackBtn){const n=document.getElementById("backToLobbyBtn");n&&(n.disabled=!1)}}const xe=e=>{const n=e;n?.roomId===a.roomId&&n?.playerIndex!==a.playerIndex&&se({showOpponentLeftAlert:!0})};l.on("room:playerLeft",xe);function q(){const e=document.querySelector(".game-area-token-label--p1 .game-area-token-n"),n=document.querySelector(".game-area-token-label--p2 .game-area-token-n");e&&(e.textContent=String(Math.max(0,J))),n&&(n.textContent=String(Math.max(0,W)))}function K(){const e=document.getElementById("gameCenterMessage");if(!e||x!=="playing")return;if(U&&H==="main"){e.textContent=p===a.playerIndex?"확인할 두 접시를 선택해주세요":"상대가 확인할 접시를 고르고 있습니다";return}if(U)return;const n=p===a.playerIndex?z+1:fe+1,t=Math.min(n,X);p===a.playerIndex?e.textContent=`토큰 ${t}개를 원하는 접시에 놓아주세요`:e.textContent=`상대가 토큰 ${t}개를 놓을 접시를 고르고 있습니다.`}function Z(e,n){const t=document.querySelector(`#gamePlateRing .game-plate[data-plate-index="${e}"] .game-plate-tokens`);if(!t)return;t.innerHTML="";const o=n[0]??0,s=n[1]??0;for(let m=0;m<o;m++){const r=document.createElement("span");r.className="game-plate-token game-plate-token--p1",r.setAttribute("aria-hidden","true"),t.appendChild(r)}for(let m=0;m<s;m++){const r=document.createElement("span");r.className="game-plate-token game-plate-token--p2",r.setAttribute("aria-hidden","true"),t.appendChild(r)}}function be(e,n){if(U)return;const t=document.getElementById("gameCenterMessage");t&&(t.innerHTML=`<span class="game-center-highlight">${e}</span>번 접시에 토큰 <span class="game-center-highlight">${n}</span> 개를 놓았습니다`)}function Ee(){if(U)return;U=!0;const e=document.getElementById("gameCenterMessage");e&&(e.textContent="빈 접시의 뚜껑을 덮습니다"),Array.from({length:Q},(o,s)=>s).filter(o=>!O.has(o)).slice(0,2).forEach(o=>{O.add(o);const s=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${o}"]`);s&&!s.classList.contains("game-plate-lid--covered")&&s.classList.add("game-plate-lid--covered");const m=document.querySelector(`#gamePlateRing .game-plate[data-plate-index="${o}"]`);m&&m.classList.add("game-plate--used")}),P=!0,setTimeout(()=>{e&&(e.textContent="이제 게임을 시작합니다");const o=document.getElementById("gameTimer");o&&o.classList.add("game-timer--hidden"),setTimeout(()=>{o&&o.classList.remove("game-timer--hidden"),P=!1,H="main",document.getElementById("gameArea")?.classList.add("game-area--main-phase"),e&&(e.textContent=a.playerIndex===E?"확인할 두 접시를 선택해주세요":"상대가 확인할 접시를 고르고 있습니다"),ee()},De)},V)}function je(e){if(k)return;const n=C.indexOf(e);if(n>=0?C.splice(n,1):C.length<2&&C.push(e),document.querySelectorAll("#gamePlateRing .game-plate-lid").forEach(t=>{const o=t.getAttribute("data-plate-index"),s=o!==null?parseInt(o,10):-1;t.classList.toggle("game-plate-lid--selected",C.includes(s))}),C.length===2){y&&(clearInterval(y),y=null);const[t,o]=[C[0],C[1]],s=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${t}"]`),m=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${o}"]`);s&&s.classList.add("game-plate-lid--uncover"),m&&m.classList.add("game-plate-lid--uncover");const r=(T[t]?.[0]??0)+(T[t]?.[1]??0),u=(T[o]?.[0]??0)+(T[o]?.[1]??0),g=r===u;l?.emit("game:mainTwoPlatesSelected",{roomId:a.roomId,playerIndex:a.playerIndex,plateA:t,plateB:o,correct:g});const I=document.getElementById("gameCenterMessage"),B=1500,R=2e3;g&&I&&(I.textContent="정답입니다"),!g&&I&&(I.textContent="틀렸습니다"),setTimeout(()=>{if(g){if(F="placeToken",a.playerIndex===0&&M===1||a.playerIndex===1&&A===1){k=!0,console.log("토큰이 1개만 남았는데 정답 맞춰서 승리!"),l?.emit("game:gameOver",{roomId:a.roomId,playerIndex:a.playerIndex,reason:"win",winnerPlayerIndex:a.playerIndex});return}I&&(I.textContent="토큰 1개를 놓을 접시를 선택해주세요"),[t,o].forEach(b=>{const w=document.querySelector(`#gamePlateRing .game-plate[data-plate-index="${b}"]`);w&&w.classList.add("game-plate--placeable")})}else{I&&(I.textContent="페널티로 토큰 1개를 받습니다"),M+=a.playerIndex===0?1:0,A+=a.playerIndex===1?1:0,q(),(M>=d*2||A>=d*2)&&(k=!0,console.log("게임이 끝났습니다 (패널티로 토큰이 tokenCount의 2배가 됨)"),l?.emit("game:gameOver",{roomId:a.roomId,playerIndex:a.playerIndex,reason:"penalty",loserPlayerIndex:a.playerIndex}));const b=document.querySelector(`.player-slot[data-slot="${a.playerIndex}"] .player-tokens`),w=a.playerIndex===0?"player-token player-token--p1":"player-token player-token--p2",S=document.createElement("span");S.className=w,S.setAttribute("aria-hidden","true"),b?.appendChild(S);const Y=j=>{j&&(j.classList.remove("game-plate-lid--uncover"),j.classList.remove("game-plate-lid--covered"),j.offsetHeight,j.classList.add("game-plate-lid--covered"))};setTimeout(()=>{Y(s),Y(m),C.length=0,document.querySelectorAll("#gamePlateRing .game-plate-lid").forEach(j=>j.classList.remove("game-plate-lid--selected")),k||(l?.emit("game:roundDone",{roomId:a.roomId,playerIndex:a.playerIndex}),l?.emit("game:mainWrongAnswerDone",{roomId:a.roomId,playerIndex:a.playerIndex}),F="selectTwoPlates",P=!1)},R)}},B)}}function Ge(e){if(k||F!=="placeToken"||C.length!==2||!C.includes(e))return;P=!0;const[n,t]=[C[0],C[1]];document.querySelectorAll("#gamePlateRing .game-plate").forEach(b=>b.classList.remove("game-plate--placeable")),C.length=0,document.querySelectorAll("#gamePlateRing .game-plate-lid").forEach(b=>b.classList.remove("game-plate-lid--selected"));const o=T[e]??{0:0,1:0},s={0:o[0]+(a.playerIndex===0?1:0),1:o[1]+(a.playerIndex===1?1:0)};T[e]=s,a.playerIndex===0?M=Math.max(0,M-1):A=Math.max(0,A-1),q(),l?.emit("game:mainTokenPlaced",{roomId:a.roomId,playerIndex:a.playerIndex,plateIndex:e,countP1:s[0],countP2:s[1]});const m=e+1,r=document.getElementById("gameCenterMessage");r&&(r.innerHTML=`<span class="game-center-highlight">${m}</span>번 접시에 토큰 1개를 더 놓았습니다`);const g=document.querySelector(`.player-slot[data-slot="${a.playerIndex}"] .player-tokens`)?.querySelector(".player-token");g&&(g.classList.add("game-token--removing"),setTimeout(()=>{g.remove()},300)),setTimeout(()=>{Z(e,s)},200);const I=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${n}"]`),B=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${t}"]`),R=b=>{b&&(b.classList.remove("game-plate-lid--uncover"),b.classList.remove("game-plate-lid--covered"),b.offsetHeight,b.classList.add("game-plate-lid--covered"))};setTimeout(()=>{R(I),R(B)},400),l?.emit("game:roundDone",{roomId:a.roomId,playerIndex:a.playerIndex}),setTimeout(()=>{F="selectTwoPlates",P=!1},400+V)}function ie(e){if(k||x!=="playing"||p!==a.playerIndex||P||O.has(e)||z+1>X)return;P=!0,y&&(clearInterval(y),y=null);const t=z+1;O.add(e),z+=1,l?.emit("game:plateClick",{roomId:a.roomId,playerIndex:a.playerIndex,plateIndex:e,round:t});const o=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${e}"]`);o&&!o.classList.contains("game-plate-lid--covered")&&o.classList.add("game-plate-lid--covered");const s=document.querySelector(`#gamePlateRing .game-plate[data-plate-index="${e}"]`);s&&s.classList.add("game-plate--used");const m=T[e]??{0:0,1:0},r={0:m[0]+(a.playerIndex===0?t:0),1:m[1]+(a.playerIndex===1?t:0)};T[e]=r,Z(e,r),a.playerIndex===0?J=Math.max(0,J-t):W=Math.max(0,W-t),q(),be(e+1,t),document.getElementById("gamePlateRing")?.dispatchEvent(new CustomEvent("plateclick",{detail:{index:e},bubbles:!0})),setTimeout(()=>{t===X&&Ie(a.playerIndex)?Ee():P=!1,l?.emit("game:roundDone",{roomId:a.roomId,playerIndex:a.playerIndex})},V)}const ke=2e3;function Ue(){P=!0,M+=p===0?1:0,A+=p===1?1:0,q();const e=document.getElementById("gameCenterMessage");e&&(e.textContent="시간 오버 페널티로 토큰1개를 받습니다");const n=document.querySelector(`.player-slot[data-slot="${p}"] .player-tokens`),t=p===0?"player-token player-token--p1":"player-token player-token--p2",o=document.createElement("span");o.className=t,o.setAttribute("aria-hidden","true"),n?.appendChild(o),(M>=d*2||A>=d*2)&&(k=!0,console.log("게임이 끝났습니다 (패널티로 토큰이 tokenCount의 2배가 됨)"),l?.emit("game:gameOver",{roomId:a.roomId,playerIndex:a.playerIndex,reason:"penalty",loserPlayerIndex:p})),l?.emit("game:mainTimeOver",{roomId:a.roomId,playerIndex:p}),setTimeout(()=>{k||(K(),P=!1,ee())},ke)}function ee(){y&&(clearInterval(y),y=null),$=H==="main"?ze:ce;const n=document.getElementById("gameTimer");n&&(n.textContent=le($)),y=setInterval(()=>{if($=Math.max(0,$-1),n&&(n.textContent=le($)),$<=0&&y){if(H==="round"&&p===a.playerIndex&&x==="playing"&&!P){const t=Array.from({length:Q},(o,s)=>s).filter(o=>!O.has(o));if(t.length>0){const o=t[Math.floor(Math.random()*t.length)];ie(o)}}H==="main"&&p===a.playerIndex&&x==="playing"&&!P&&!k&&Ue(),clearInterval(y),y=null}},1e3)}const Se=e=>{const n=e;if(n?.roomId!==a.roomId)return;const t=n.plateIndex??-1,o=n.round??0;if(t<0||o<1||n.playerIndex===a.playerIndex)return;fe=o,O.add(t);const s=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${t}"]`);s&&!s.classList.contains("game-plate-lid--covered")&&s.classList.add("game-plate-lid--covered");const m=document.querySelector(`#gamePlateRing .game-plate[data-plate-index="${t}"]`);m&&m.classList.add("game-plate--used");const r=T[t]??{0:0,1:0},u=n.playerIndex??0,g={0:r[0]+(u===0?o:0),1:r[1]+(u===1?o:0)};T[t]=g,Z(t,g),n.playerIndex===0?J=Math.max(0,J-o):W=Math.max(0,W-o),q(),be(t+1,o),Ie(n.playerIndex??-1)&&o===X&&setTimeout(()=>Ee(),V)};l.on("game:plateClick",Se);const Fe=e=>{const n=e;if(n?.roomId!==a.roomId||n.playerIndex===a.playerIndex)return;const t=n.plateA??-1,o=n.plateB??-1;if(t<0||o<0)return;D=[t,o];const s=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${t}"]`),m=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${o}"]`);s&&s.classList.add("game-plate-lid--uncover"),m&&m.classList.add("game-plate-lid--uncover");const r=document.getElementById("gameCenterMessage");n.correct&&r&&(r.textContent="상대가 정답을 맞췄습니다"),!n.correct&&r&&(r.textContent="상대가 틀렸습니다"),setTimeout(()=>{if(n.correct&&r&&(r.textContent="상대가 토큰 1개를 놓을 접시를 선택중입니다"),!n.correct&&r){r.textContent="상대방이 페널티로 토큰 1개를 받았습니다";const g=n.playerIndex??0;g===0?M+=1:A+=1,q();const I=document.querySelector(`.player-slot[data-slot="${g}"] .player-tokens`),B=g===0?"player-token player-token--p1":"player-token player-token--p2",R=document.createElement("span");R.className=B,R.setAttribute("aria-hidden","true"),I?.appendChild(R),(M>=d*2||A>=d*2)&&(k=!0,console.log("게임이 끝났습니다 (상대가 패널티로 토큰이 tokenCount의 2배가 됨)"))}},1500)};l.on("game:mainTwoPlatesSelected",Fe);const Je=e=>{const n=e;if(n?.roomId!==a.roomId||n.playerIndex===a.playerIndex)return;const t=n.playerIndex??0;M+=t===0?1:0,A+=t===1?1:0,q();const o=document.getElementById("gameCenterMessage");o&&(o.textContent="상대방이 시간오버 페널티로 토큰1개를 받습니다");const s=document.querySelector(`.player-slot[data-slot="${t}"] .player-tokens`),m=t===0?"player-token player-token--p1":"player-token player-token--p2",r=document.createElement("span");r.className=m,r.setAttribute("aria-hidden","true"),s?.appendChild(r),(M>=d*2||A>=d*2)&&(k=!0,console.log("게임이 끝났습니다 (상대가 패널티로 토큰이 tokenCount의 2배가 됨)")),setTimeout(()=>{K()},ke)};l.on("game:mainTimeOver",Je);const Le=e=>{if(e?.roomId!==a.roomId)return;k=!0;const t=document.getElementById("gameCenterMessage");t&&(t.textContent="GameOver"),setTimeout(()=>{t&&(t.textContent="잠시 후 종료됩니다"),setTimeout(()=>{l?.emit("game:gameEndFinalize",{roomId:a.roomId})},2e3)},3e3)};l.on("game:gameOver",Le);const Ce=e=>{e?.roomId===a.roomId&&se({skipEmitAndApi:!0})};l.on("game:roomClosed",Ce);const We=e=>{const n=e;if(n?.roomId!==a.roomId||n.playerIndex===a.playerIndex||!D)return;const[t,o]=D,s=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${t}"]`),m=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${o}"]`),r=u=>{u&&(u.classList.remove("game-plate-lid--uncover"),u.classList.remove("game-plate-lid--covered"),u.offsetHeight,u.classList.add("game-plate-lid--covered"))};r(s),r(m),D=null};l.on("game:mainWrongAnswerDone",We);const Ve=e=>{const n=e;if(n?.roomId!==a.roomId||n.playerIndex===a.playerIndex)return;const t=n.plateIndex??-1;if(t<0)return;const o=n.countP1??0,s=n.countP2??0;T[t]={0:o,1:s},n.playerIndex===0?M=Math.max(0,M-1):A=Math.max(0,A-1),q();const r=document.querySelector(`.player-slot[data-slot="${n.playerIndex}"] .player-tokens`)?.querySelector(".player-token");r&&(r.classList.add("game-token--removing"),setTimeout(()=>r.remove(),300));const u=t+1,g=document.getElementById("gameCenterMessage");if(g&&(g.innerHTML=`<span class="game-center-highlight">${u}</span>번 접시에 토큰 1개를 더 놓았습니다`),document.querySelectorAll("#gamePlateRing .game-plate").forEach(I=>I.classList.remove("game-plate--placeable")),setTimeout(()=>{Z(t,{0:o,1:s})},200),D){const[I,B]=D,R=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${I}"]`),b=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${B}"]`),w=S=>{S&&(S.classList.remove("game-plate-lid--uncover"),S.classList.remove("game-plate-lid--covered"),S.offsetHeight,S.classList.add("game-plate-lid--covered"))};setTimeout(()=>{w(R),w(b)},400),D=null}};l.on("game:mainTokenPlaced",Ve);const Te=e=>{const n=e;if(n?.roomId!==a.roomId)return;p=n.currentTurn===0||n.currentTurn===1?n.currentTurn:p,document.getElementById("roomPlayers")?.querySelectorAll(".player-slot")?.forEach((s,m)=>{s.classList.toggle("player-slot--turn",x==="playing"&&m===p)}),U&&H==="main"?setTimeout(()=>K(),V):K(),ee()};l.on("game:turnSwitch",Te);function Pe(){const e=document.getElementById("gameAreaContent");if(e)if(y&&(clearInterval(y),y=null),x==="ready"){const n=he?'<button type="button" class="game-ready-btn" id="readyBtn" disabled>Ready</button>':'<p class="game-phase-label game-phase-label--waiting" aria-live="polite">방장이 게임을 시작할 때까지 기다리는 중…</p>';e.innerHTML=`
        <p class="game-phase-label" aria-live="polite"></p>
        ${n}
      `;const t=e.querySelector("#readyBtn");t&&t.addEventListener("click",()=>{l?.emit("game:start",{roomId:a.roomId})})}else{document.getElementById("gameRoom")?.classList.add("game-room--playing"),document.getElementById("gameArea")?.classList.add("game-area--playing");const n=Qe.trim()||" ",t=Q,o=Array.from({length:t},(m,r)=>{const u=360/t*r,g=r+1;return`
          <div class="game-plate" data-plate-index="${r}" style="--plate-angle: ${u}deg" role="button" tabindex="0" aria-label="접시 ${g}">
            <span class="game-plate-number" aria-hidden="true">${g}</span>
            <div class="game-plate-tokens" aria-hidden="true"></div>
          </div>
          <div class="game-plate-lid" data-plate-index="${r}" style="--plate-angle: ${u}deg" aria-hidden="true"></div>`}).join("");e.innerHTML=`
        <div class="game-plate-ring" id="gamePlateRing">
          ${o}
          <div class="game-center-zone">
            <div id="gameTimer" class="game-timer">${le($)}</div>
            <div id="gameCenterMessage" class="game-center-message">${te(n)}</div>
          </div>
        </div>
        <div id="gameMainContent" class="game-main-content"></div>
      `;const s=e.querySelector(".game-plate-ring");s?.addEventListener("click",m=>{if(k)return;const r=m.target,u=p===a.playerIndex;if(H==="main"&&u&&!P){if(F==="placeToken"){const w=r.closest(".game-plate.game-plate--placeable");if(w){const S=w.getAttribute("data-plate-index");if(S!==null){const Y=parseInt(S,10);Number.isNaN(Y)||Ge(Y)}return}}const b=r.closest(".game-plate-lid");if(b){const w=b.getAttribute("data-plate-index");if(w!==null){const S=parseInt(w,10);Number.isNaN(S)||je(S)}return}}const I=r.closest(".game-plate");if(!I)return;const B=I.getAttribute("data-plate-index");if(B===null)return;const R=parseInt(B,10);Number.isNaN(R)||ie(R)}),s?.addEventListener("keydown",m=>{if(k)return;const r=m;if(r.key!=="Enter"&&r.key!==" ")return;const u=m.target.closest(".game-plate");if(!u)return;r.preventDefault();const g=u.getAttribute("data-plate-index");if(g===null)return;const I=parseInt(g,10);Number.isNaN(I)||ie(I)}),ee(),K()}}Pe();const Me=document.getElementById("backToLobbyBtn");Me.addEventListener("click",()=>{Me.disabled=!0,se({emitSocketLeave:!0,reenableBackBtn:!0})});const Ae=document.getElementById("gameWrap");Ae&&Ae.addEventListener("click",e=>{if(k)return;const n=e.target;x==="playing"&&p!==a.playerIndex&&(n.closest("#backToLobbyBtn")||He("본인 차례가 아닐때는 클릭할 수 없습니다"))});function Be(e){const n=document.getElementById("roomPlayers");if(!e)return;p=e.currentTurn??0,(e.firstPlayerIndex===0||e.firstPlayerIndex===1)&&(E=e.firstPlayerIndex);const t=e.player1?.name??"대기 중",o=e.player2?.name??"대기 중",s=a.playerIndex,m=n?.querySelectorAll(".player-slot");if(m&&m.length>=2){const r=[t,o];m.forEach((u,g)=>{const I=u.querySelector(".player-name"),B=u.querySelector(".player-badge");I&&(I.textContent=r[g]??"대기 중"),B&&(B.hidden=g!==s),u.classList.toggle("player-slot--me",g===s),u.classList.toggle("player-slot--turn",x==="playing"&&g===p)})}if(x==="ready"&&he){const r=document.getElementById("readyBtn");if(r){const u=!!(e.player1&&e.player2);r.disabled=!u}}}async function Re(){const e=await Ne(a.roomId);Be(e)}Re(),N&&clearInterval(N),N=setInterval(Re,Ye)}function nt(){_e(),ye();const i=re(),c=qe();if(!i){de();return}if(c){me();return}oe()}nt();
