(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const f of document.querySelectorAll('link[rel="modulepreload"]'))d(f);new MutationObserver(f=>{for(const h of f)if(h.type==="childList")for(const L of h.addedNodes)L.tagName==="LINK"&&L.rel==="modulepreload"&&d(L)}).observe(document,{childList:!0,subtree:!0});function v(f){const h={};return f.integrity&&(h.integrity=f.integrity),f.referrerPolicy&&(h.referrerPolicy=f.referrerPolicy),f.crossOrigin==="use-credentials"?h.credentials="include":f.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function d(f){if(f.ep)return;f.ep=!0;const h=v(f);fetch(f.href,h)}})();function _e(){const i=window;if(!i.io)throw new Error("Socket.IO not loaded. Check index.html script order.");return i.io}let F=null;async function Ye(){if(F)return F;try{const s=await(await fetch(`${window.location.origin}/api/config`)).json();if(s.ok&&typeof s.socketUrl=="string"&&s.socketUrl)return F=s.socketUrl,F}catch{}return F="https://remembergame2-production-2e29.up.railway.app",F}let H="https://remembergame2-production-2e29.up.railway.app";async function qe(){l||(H=await Ye(),l=_e()(H,{path:"/socket.io",transports:["websocket","polling"]}),l.on("connect",()=>{const i=le()?.name??"";l?.emit("login",{name:i||void 0})}))}const ue="remember_game2_user",ge="remember_game2_room",ze=3e3,Qe=2e3,de=30,Xe=60,Ze="",ae=10;let _=null,N=null,l=null;function ne(i){const s=document.createElement("div");return s.textContent=i,s.innerHTML}function ye(){const i=document.getElementById("app");if(!i)throw new Error("#app not found");return i}function le(){try{const i=localStorage.getItem(ue);if(!i)return null;const s=JSON.parse(i);if(s&&typeof s=="object"&&"name"in s&&typeof s.name=="string")return s}catch{}return null}function et(i){const s={id:`local_${Date.now()}_${Math.random().toString(36).slice(2,9)}`,name:i};return localStorage.setItem(ue,JSON.stringify(s)),s}function He(){try{const i=sessionStorage.getItem(ge);if(!i)return null;const s=JSON.parse(i);if(s&&typeof s=="object"&&"roomId"in s&&"playerIndex"in s)return s}catch{}return null}function $e(i,s,v){sessionStorage.setItem(ge,JSON.stringify({roomId:i,playerIndex:s,plateCount:v}))}function fe(){sessionStorage.removeItem(ge)}function oe(){return(le()?.name??"").trim()||"플레이어"}async function tt(){try{const s=await(await fetch(`${H}/api/rooms`)).json();return s.ok&&Array.isArray(s.rooms)?s.rooms:[]}catch{return[]}}async function nt(i){const s=oe(),d=await(await fetch(`${H}/api/rooms`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({plateCount:i,creatorName:s})})).json();if(!d.ok||!d.roomId)throw new Error(d.error??"방 생성에 실패했습니다.");const f=d.room?.plateCount??i;return{roomId:d.roomId,plateCount:f}}async function Ne(i,s){const d=await(await fetch(`${H}/api/rooms/${encodeURIComponent(i)}/join`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({playerName:s})})).json();if(!d.ok||d.playerIndex===void 0)throw new Error(d.error??"방 참가에 실패했습니다.");return{playerIndex:d.playerIndex,room:d.room??null}}async function at(i,s){const d=await(await fetch(`${H}/api/rooms/${encodeURIComponent(i)}/leave`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({playerIndex:s})})).json();if(!d.ok)throw new Error(d.error??"방 나가기에 실패했습니다.")}async function Oe(i){try{const v=await(await fetch(`${H}/api/rooms/${encodeURIComponent(i)}`)).json();return v.ok&&v.room?v.room:null}catch{return null}}function me(){_&&(clearInterval(_),_=null),N&&(clearInterval(N),N=null);const i=ye();i.innerHTML=`
    <main class="login-wrap">
      <h1 class="login-title">remember_game2</h1>
      <p class="login-desc">1:1 온라인 게임</p>
      <form id="loginForm" class="login-form" novalidate>
        <label for="nickname" class="sr-only">닉네임</label>
        <input type="text" id="nickname" name="nickname" class="login-input" placeholder="닉네임 입력" minlength="2" maxlength="12" autocomplete="username" required />
        <span id="nicknameError" class="login-error" aria-live="polite"></span>
        <button type="submit" class="login-btn" id="loginBtn">로그인</button>
      </form>
      <p class="login-foot">현재 로컬 스토리지 저장 · 추후 DB 연동 예정</p>
    </main>
  `;const s=document.getElementById("loginForm"),v=document.getElementById("nickname"),d=document.getElementById("nicknameError"),f=document.getElementById("loginBtn");s.addEventListener("submit",async h=>{h.preventDefault(),d.textContent="",v.classList.remove("invalid");const L=v.value.trim();if(L.length<2){d.textContent="닉네임은 2자 이상 입력해 주세요.",v.classList.add("invalid"),v.focus();return}if(L.length>12){d.textContent="닉네임은 12자 이하로 입력해 주세요.",v.classList.add("invalid");return}f.disabled=!0,et(L),await qe(),l?.emit("login",{name:L}),re()})}function re(){N&&(clearInterval(N),N=null);const i=le();if(!i){me();return}const s=ye(),v=[10,12,14,16,18,20];s.innerHTML=`
    <main class="login-wrap lobby-wrap">
      <h1 class="login-title">로비</h1>
      <p class="login-desc">방을 만들거나 참가할 수 있습니다</p>
      <div class="lobby-user" id="userInfo">로그인됨: <strong>${ne(i.name)}</strong></div>
      <section class="lobby-section lobby-section-create">
        <div class="lobby-plate-row">
          <label for="plateCountSelect" class="lobby-label">접시 개수</label>
          <select id="plateCountSelect" class="lobby-select" aria-describedby="plateCountHint">
            ${v.map(x=>`<option value="${x}">${x}개</option>`).join("")}
          </select>
        </div>
        <span id="plateCountHint" class="lobby-hint">방 만들 때 사용됩니다 (10~20개, 2단위)</span>
        <button type="button" class="lobby-btn primary" id="createRoomBtn">방 만들기</button>
      </section>
      <section class="lobby-section">
        <h2 class="lobby-section-title">참가 가능한 방</h2>
        <div id="roomList" class="room-list">불러오는 중…</div>
        <p class="lobby-hint" id="roomListHint">다른 사용자가 만든 방이 여기 표시됩니다</p>
      </section>
      <button type="button" class="logout-btn" id="logoutBtn">로그아웃</button>
    </main>
  `;const d=document.getElementById("createRoomBtn"),f=document.getElementById("logoutBtn"),h=document.getElementById("roomList"),L=document.getElementById("roomListHint");f.addEventListener("click",()=>{localStorage.removeItem(ue),fe(),me()}),d.addEventListener("click",async()=>{d.disabled=!0;const x=document.getElementById("plateCountSelect"),p=x?Math.min(20,Math.max(10,parseInt(x.value,10)||10)):10;try{const{roomId:k,plateCount:y}=await nt(p),$=oe(),{playerIndex:O}=await Ne(k,$);$e(k,O,y),pe()}catch(k){alert(k instanceof Error?k.message:"방 생성에 실패했습니다."),d.disabled=!1}});function a(){tt().then(x=>{if(!(!h||!L)){if(x.length===0){h.innerHTML='<p class="lobby-hint">참가 가능한 방이 없습니다.</p>',L.textContent="방 만들기 후 다른 사용자가 여기서 참가할 수 있습니다.";return}L.textContent="",h.innerHTML=x.map(p=>{const k=p.player1?.name??"대기 중",y=p.plateCount??ae;return`
            <div class="room-item">
              <div>
                <span class="room-item-player">${ne(k)} 대기 중</span>
                <span class="room-item-plates">접시 ${y}개</span>
              </div>
              <button type="button" class="lobby-btn join" data-room-id="${ne(p.id)}">참가</button>
            </div>
          `}).join(""),h.querySelectorAll(".lobby-btn.join").forEach(p=>{p.addEventListener("click",async()=>{const k=p.dataset.roomId;if(k){p.disabled=!0;try{const y=oe(),{playerIndex:$,room:O}=await Ne(k,y),T=O?.plateCount??ae;$e(k,$,T),pe()}catch(y){alert(y instanceof Error?y.message:"참가에 실패했습니다."),p.disabled=!1}}})})}}).catch(()=>{h&&(h.textContent="방 목록을 불러올 수 없습니다.")})}a(),_&&clearInterval(_),_=setInterval(a,ze)}function pe(){_&&(clearInterval(_),_=null);const i=He();if(!i){re();return}const s=ye(),v=Math.min(20,Math.max(10,i.plateCount??ae)),d=Math.min(10,Math.floor(v/2)),f=d*(d-1)/2,h=Array.from({length:d},()=>'<span class="player-token player-token--p1" aria-hidden="true"></span>').join(""),L=Array.from({length:d},()=>'<span class="player-token player-token--p2" aria-hidden="true"></span>').join("");s.innerHTML=`
    <main class="login-wrap game-wrap" id="gameWrap">
      <h1 class="login-title">기억의 만찬</h1>
      <div id="gameRoom" class="game-room">
        <div id="roomPlayers" class="game-room-players">
          <div class="player-slot" data-slot="0">
            <span class="player-label">1P</span>
            <div class="player-info">
              <span class="player-name"></span>
              <span class="player-badge" aria-hidden="true">나</span>
            </div>
            <div class="player-tokens">${h}</div>
          </div>
          <span class="game-room-vs" aria-hidden="true">VS</span>
          <div class="player-slot" data-slot="1">
            <span class="player-label">2P</span>
            <div class="player-info">
              <span class="player-name"></span>
              <span class="player-badge" aria-hidden="true">나</span>
            </div>
            <div class="player-tokens">${L}</div>
          </div>
        </div>
      </div>
      <div id="gameArea" class="game-area">
        <div class="game-area-token-label game-area-token-label--p1" aria-hidden="true"><span class="player-token player-token--p1" aria-hidden="true"></span> x <span class="game-area-token-n">${f}</span></div>
        <div class="game-area-token-label game-area-token-label--p2" aria-hidden="true"><span class="player-token player-token--p2" aria-hidden="true"></span> x <span class="game-area-token-n">${f}</span></div>
        <div id="gameAreaContent"></div>
      </div>
      <button type="button" class="logout-btn" id="backToLobbyBtn">나가기</button>
    </main>
  `;const a=i;let x="ready",p=0,k=0,y=null,$=de;const O=new Set,T={};let Q=0,Ie=0,P=!1,E=!1,j="round";const C=[];let J="selectTwoPlates",D=null,W=f,V=f,M=d,A=d;const K=2e3;function se(e){const n=Math.floor(e/60),t=e%60;return`${n.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`}const X=Math.min(20,Math.max(10,a.plateCount??ae));function je(e){const n=document.getElementById("gameNotice");n&&n.remove();const t=document.createElement("div");t.id="gameNotice",t.className="game-notice",t.setAttribute("role","alert"),t.textContent=e,document.body.appendChild(t),setTimeout(()=>t.remove(),2500)}const Z=Math.floor(X/2)-1;function he(e){return e===1-k}const De=3e3;let G=!1;const ve=a.playerIndex===0;l||(l=_e()(H,{path:"/socket.io",transports:["websocket","polling"]})),l.emit("game:joinRoom",{roomId:a.roomId,playerIndex:a.playerIndex,playerName:oe()});const xe=e=>{e?.roomId===a.roomId&&(x="playing",$=de,Me(),Oe(a.roomId).then(t=>{t&&Be(t)}))};l.on("game:start",xe);function ie(e){if(y&&(clearInterval(y),y=null),N&&(clearInterval(N),N=null),l&&l.off("room:playerLeft",be),l&&l.off("game:start",xe),l&&l.off("game:plateClick",Le),l&&l.off("game:mainTwoPlatesSelected"),l&&l.off("game:mainTokenPlaced"),l&&l.off("game:mainWrongAnswerDone"),l&&l.off("game:mainTimeOver"),l&&l.off("game:turnSwitch",Pe),l&&l.off("game:gameOver",Ce),l&&l.off("game:roomClosed",Te),e.emitSocketLeave&&l?.emit("room:leave",{roomId:a.roomId,playerIndex:a.playerIndex}),e.skipEmitAndApi||at(a.roomId,a.playerIndex).catch(()=>{}),fe(),e.showOpponentLeftAlert&&alert("상대가 방을 나갔습니다."),re(),e.reenableBackBtn){const n=document.getElementById("backToLobbyBtn");n&&(n.disabled=!1)}}const be=e=>{const n=e;n?.roomId===a.roomId&&n?.playerIndex!==a.playerIndex&&ie({showOpponentLeftAlert:!0})};l.on("room:playerLeft",be);function q(){const e=document.querySelector(".game-area-token-label--p1 .game-area-token-n"),n=document.querySelector(".game-area-token-label--p2 .game-area-token-n");e&&(e.textContent=String(Math.max(0,W))),n&&(n.textContent=String(Math.max(0,V)))}function Y(){const e=document.getElementById("gameCenterMessage");if(!e||x!=="playing")return;if(G&&j==="main"){e.textContent=p===a.playerIndex?"확인할 두 접시를 선택해주세요":"상대가 확인할 접시를 고르고 있습니다";return}if(G)return;const n=p===a.playerIndex?Q+1:Ie+1,t=Math.min(n,Z);p===a.playerIndex?e.textContent=`토큰 ${t}개를 원하는 접시에 놓아주세요`:e.textContent=`상대가 토큰 ${t}개를 놓을 접시를 고르고 있습니다.`}function ee(e,n){const t=document.querySelector(`#gamePlateRing .game-plate[data-plate-index="${e}"] .game-plate-tokens`);if(!t)return;t.innerHTML="";const o=n[0]??0,c=n[1]??0;for(let m=0;m<o;m++){const r=document.createElement("span");r.className="game-plate-token game-plate-token--p1",r.setAttribute("aria-hidden","true"),t.appendChild(r)}for(let m=0;m<c;m++){const r=document.createElement("span");r.className="game-plate-token game-plate-token--p2",r.setAttribute("aria-hidden","true"),t.appendChild(r)}}function ke(e,n){if(G)return;const t=document.getElementById("gameCenterMessage");t&&(t.innerHTML=`<span class="game-center-highlight">${e}</span>번 접시에 토큰 <span class="game-center-highlight">${n}</span> 개를 놓았습니다`)}function Ee(){if(G)return;G=!0;const e=document.getElementById("gameCenterMessage");e&&(e.textContent="빈 접시의 뚜껑을 덮습니다"),Array.from({length:X},(o,c)=>c).filter(o=>!O.has(o)).slice(0,2).forEach(o=>{O.add(o);const c=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${o}"]`);c&&!c.classList.contains("game-plate-lid--covered")&&c.classList.add("game-plate-lid--covered");const m=document.querySelector(`#gamePlateRing .game-plate[data-plate-index="${o}"]`);m&&m.classList.add("game-plate--used")}),P=!0,setTimeout(()=>{e&&(e.textContent="이제 게임을 시작합니다");const o=document.getElementById("gameTimer");o&&o.classList.add("game-timer--hidden"),setTimeout(()=>{o&&o.classList.remove("game-timer--hidden"),P=!1,j="main",document.getElementById("gameArea")?.classList.add("game-area--main-phase"),e&&(e.textContent=a.playerIndex===k?"확인할 두 접시를 선택해주세요":"상대가 확인할 접시를 고르고 있습니다"),te()},De)},K)}function Ue(e){if(E)return;const n=C.indexOf(e);if(n>=0?C.splice(n,1):C.length<2&&C.push(e),document.querySelectorAll("#gamePlateRing .game-plate-lid").forEach(t=>{const o=t.getAttribute("data-plate-index"),c=o!==null?parseInt(o,10):-1;t.classList.toggle("game-plate-lid--selected",C.includes(c))}),C.length===2){y&&(clearInterval(y),y=null);const[t,o]=[C[0],C[1]],c=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${t}"]`),m=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${o}"]`);c&&c.classList.add("game-plate-lid--uncover"),m&&m.classList.add("game-plate-lid--uncover");const r=(T[t]?.[0]??0)+(T[t]?.[1]??0),u=(T[o]?.[0]??0)+(T[o]?.[1]??0),g=r===u;l?.emit("game:mainTwoPlatesSelected",{roomId:a.roomId,playerIndex:a.playerIndex,plateA:t,plateB:o,correct:g});const I=document.getElementById("gameCenterMessage"),w=1500,B=2e3;g&&I&&(I.textContent="정답입니다"),!g&&I&&(I.textContent="틀렸습니다"),setTimeout(()=>{if(g){if(J="placeToken",a.playerIndex===0&&M===1||a.playerIndex===1&&A===1){E=!0,console.log("토큰이 1개만 남았는데 정답 맞춰서 승리!"),l?.emit("game:gameOver",{roomId:a.roomId,playerIndex:a.playerIndex,reason:"win",winnerPlayerIndex:a.playerIndex});return}I&&(I.textContent="토큰 1개를 놓을 접시를 선택해주세요"),[t,o].forEach(b=>{const R=document.querySelector(`#gamePlateRing .game-plate[data-plate-index="${b}"]`);R&&R.classList.add("game-plate--placeable")})}else{I&&(I.textContent="페널티로 토큰 1개를 받습니다"),M+=a.playerIndex===0?1:0,A+=a.playerIndex===1?1:0,q(),(M>=d*2||A>=d*2)&&(E=!0,console.log("게임이 끝났습니다 (패널티로 토큰이 tokenCount의 2배가 됨)"),l?.emit("game:gameOver",{roomId:a.roomId,playerIndex:a.playerIndex,reason:"penalty",loserPlayerIndex:a.playerIndex}));const b=document.querySelector(`.player-slot[data-slot="${a.playerIndex}"] .player-tokens`),R=a.playerIndex===0?"player-token player-token--p1":"player-token player-token--p2",S=document.createElement("span");S.className=R,S.setAttribute("aria-hidden","true"),b?.appendChild(S);const z=U=>{U&&(U.classList.remove("game-plate-lid--uncover"),U.classList.remove("game-plate-lid--covered"),U.offsetHeight,U.classList.add("game-plate-lid--covered"))};setTimeout(()=>{z(c),z(m),C.length=0,document.querySelectorAll("#gamePlateRing .game-plate-lid").forEach(U=>U.classList.remove("game-plate-lid--selected")),E||(l?.emit("game:roundDone",{roomId:a.roomId,playerIndex:a.playerIndex}),l?.emit("game:mainWrongAnswerDone",{roomId:a.roomId,playerIndex:a.playerIndex}),J="selectTwoPlates",P=!1)},B)}},w)}}function Ge(e){if(E||J!=="placeToken"||C.length!==2||!C.includes(e))return;P=!0;const[n,t]=[C[0],C[1]];document.querySelectorAll("#gamePlateRing .game-plate").forEach(b=>b.classList.remove("game-plate--placeable")),C.length=0,document.querySelectorAll("#gamePlateRing .game-plate-lid").forEach(b=>b.classList.remove("game-plate-lid--selected"));const o=T[e]??{0:0,1:0},c={0:o[0]+(a.playerIndex===0?1:0),1:o[1]+(a.playerIndex===1?1:0)};T[e]=c,a.playerIndex===0?M=Math.max(0,M-1):A=Math.max(0,A-1),q(),l?.emit("game:mainTokenPlaced",{roomId:a.roomId,playerIndex:a.playerIndex,plateIndex:e,countP1:c[0],countP2:c[1]});const m=e+1,r=document.getElementById("gameCenterMessage");r&&(r.innerHTML=`<span class="game-center-highlight">${m}</span>번 접시에 토큰 1개를 더 놓았습니다`);const g=document.querySelector(`.player-slot[data-slot="${a.playerIndex}"] .player-tokens`)?.querySelector(".player-token");g&&(g.classList.add("game-token--removing"),setTimeout(()=>{g.remove()},300)),setTimeout(()=>{ee(e,c)},200);const I=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${n}"]`),w=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${t}"]`),B=b=>{b&&(b.classList.remove("game-plate-lid--uncover"),b.classList.remove("game-plate-lid--covered"),b.offsetHeight,b.classList.add("game-plate-lid--covered"))};setTimeout(()=>{B(I),B(w)},400),l?.emit("game:roundDone",{roomId:a.roomId,playerIndex:a.playerIndex}),setTimeout(()=>{J="selectTwoPlates",P=!1},400+K)}function ce(e){if(E||x!=="playing"||p!==a.playerIndex||P||O.has(e)||Q+1>Z)return;P=!0,y&&(clearInterval(y),y=null);const t=Q+1;O.add(e),Q+=1,l?.emit("game:plateClick",{roomId:a.roomId,playerIndex:a.playerIndex,plateIndex:e,round:t});const o=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${e}"]`);o&&!o.classList.contains("game-plate-lid--covered")&&o.classList.add("game-plate-lid--covered");const c=document.querySelector(`#gamePlateRing .game-plate[data-plate-index="${e}"]`);c&&c.classList.add("game-plate--used");const m=T[e]??{0:0,1:0},r={0:m[0]+(a.playerIndex===0?t:0),1:m[1]+(a.playerIndex===1?t:0)};T[e]=r,ee(e,r),a.playerIndex===0?W=Math.max(0,W-t):V=Math.max(0,V-t),q(),ke(e+1,t),document.getElementById("gamePlateRing")?.dispatchEvent(new CustomEvent("plateclick",{detail:{index:e},bubbles:!0})),setTimeout(()=>{t===Z&&he(a.playerIndex)?Ee():P=!1,l?.emit("game:roundDone",{roomId:a.roomId,playerIndex:a.playerIndex})},K)}const Se=2e3;function Fe(){P=!0,M+=p===0?1:0,A+=p===1?1:0,q();const e=document.getElementById("gameCenterMessage");e&&(e.textContent="시간 오버 페널티로 토큰1개를 받습니다");const n=document.querySelector(`.player-slot[data-slot="${p}"] .player-tokens`),t=p===0?"player-token player-token--p1":"player-token player-token--p2",o=document.createElement("span");o.className=t,o.setAttribute("aria-hidden","true"),n?.appendChild(o),(M>=d*2||A>=d*2)&&(E=!0,console.log("게임이 끝났습니다 (패널티로 토큰이 tokenCount의 2배가 됨)"),l?.emit("game:gameOver",{roomId:a.roomId,playerIndex:a.playerIndex,reason:"penalty",loserPlayerIndex:p})),l?.emit("game:mainTimeOver",{roomId:a.roomId,playerIndex:p}),setTimeout(()=>{E||(Y(),P=!1,te())},Se)}function te(){y&&(clearInterval(y),y=null),$=j==="main"?Xe:de;const n=document.getElementById("gameTimer");n&&(n.textContent=se($)),y=setInterval(()=>{if($=Math.max(0,$-1),n&&(n.textContent=se($)),$<=0&&y){if(j==="round"&&p===a.playerIndex&&x==="playing"&&!P){const t=Array.from({length:X},(o,c)=>c).filter(o=>!O.has(o));if(t.length>0){const o=t[Math.floor(Math.random()*t.length)];ce(o)}}j==="main"&&p===a.playerIndex&&x==="playing"&&!P&&!E&&Fe(),clearInterval(y),y=null}},1e3)}const Le=e=>{const n=e;if(n?.roomId!==a.roomId)return;const t=n.plateIndex??-1,o=n.round??0;if(t<0||o<1||n.playerIndex===a.playerIndex)return;Ie=o,O.add(t);const c=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${t}"]`);c&&!c.classList.contains("game-plate-lid--covered")&&c.classList.add("game-plate-lid--covered");const m=document.querySelector(`#gamePlateRing .game-plate[data-plate-index="${t}"]`);m&&m.classList.add("game-plate--used");const r=T[t]??{0:0,1:0},u=n.playerIndex??0,g={0:r[0]+(u===0?o:0),1:r[1]+(u===1?o:0)};T[t]=g,ee(t,g),n.playerIndex===0?W=Math.max(0,W-o):V=Math.max(0,V-o),q(),ke(t+1,o),he(n.playerIndex??-1)&&o===Z&&setTimeout(()=>Ee(),K)};l.on("game:plateClick",Le);const Je=e=>{const n=e;if(n?.roomId!==a.roomId||n.playerIndex===a.playerIndex)return;const t=n.plateA??-1,o=n.plateB??-1;if(t<0||o<0)return;D=[t,o];const c=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${t}"]`),m=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${o}"]`);c&&c.classList.add("game-plate-lid--uncover"),m&&m.classList.add("game-plate-lid--uncover");const r=document.getElementById("gameCenterMessage");n.correct&&r&&(r.textContent="상대가 정답을 맞췄습니다"),!n.correct&&r&&(r.textContent="상대가 틀렸습니다"),setTimeout(()=>{if(n.correct&&r&&(r.textContent="상대가 토큰 1개를 놓을 접시를 선택중입니다"),!n.correct&&r){r.textContent="상대방이 페널티로 토큰 1개를 받았습니다";const g=n.playerIndex??0;g===0?M+=1:A+=1,q();const I=document.querySelector(`.player-slot[data-slot="${g}"] .player-tokens`),w=g===0?"player-token player-token--p1":"player-token player-token--p2",B=document.createElement("span");B.className=w,B.setAttribute("aria-hidden","true"),I?.appendChild(B),(M>=d*2||A>=d*2)&&(E=!0,console.log("게임이 끝났습니다 (상대가 패널티로 토큰이 tokenCount의 2배가 됨)"))}},1500)};l.on("game:mainTwoPlatesSelected",Je);const We=e=>{const n=e;if(n?.roomId!==a.roomId||n.playerIndex===a.playerIndex)return;const t=n.playerIndex??0;M+=t===0?1:0,A+=t===1?1:0,q();const o=document.getElementById("gameCenterMessage");o&&(o.textContent="상대방이 시간오버 페널티로 토큰1개를 받습니다");const c=document.querySelector(`.player-slot[data-slot="${t}"] .player-tokens`),m=t===0?"player-token player-token--p1":"player-token player-token--p2",r=document.createElement("span");r.className=m,r.setAttribute("aria-hidden","true"),c?.appendChild(r),(M>=d*2||A>=d*2)&&(E=!0,console.log("게임이 끝났습니다 (상대가 패널티로 토큰이 tokenCount의 2배가 됨)")),setTimeout(()=>{Y()},Se)};l.on("game:mainTimeOver",We);const Ce=e=>{if(e?.roomId!==a.roomId)return;E=!0;const t=document.getElementById("gameCenterMessage");t&&(t.textContent="GameOver"),setTimeout(()=>{t&&(t.textContent="잠시 후 종료됩니다"),setTimeout(()=>{l?.emit("game:gameEndFinalize",{roomId:a.roomId})},2e3)},3e3)};l.on("game:gameOver",Ce);const Te=e=>{e?.roomId===a.roomId&&ie({skipEmitAndApi:!0})};l.on("game:roomClosed",Te);const Ve=e=>{const n=e;if(n?.roomId!==a.roomId||n.playerIndex===a.playerIndex||!D)return;const[t,o]=D,c=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${t}"]`),m=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${o}"]`),r=u=>{u&&(u.classList.remove("game-plate-lid--uncover"),u.classList.remove("game-plate-lid--covered"),u.offsetHeight,u.classList.add("game-plate-lid--covered"))};r(c),r(m),D=null};l.on("game:mainWrongAnswerDone",Ve);const Ke=e=>{const n=e;if(n?.roomId!==a.roomId||n.playerIndex===a.playerIndex)return;const t=n.plateIndex??-1;if(t<0)return;const o=n.countP1??0,c=n.countP2??0;T[t]={0:o,1:c},n.playerIndex===0?M=Math.max(0,M-1):A=Math.max(0,A-1),q();const r=document.querySelector(`.player-slot[data-slot="${n.playerIndex}"] .player-tokens`)?.querySelector(".player-token");r&&(r.classList.add("game-token--removing"),setTimeout(()=>r.remove(),300));const u=t+1,g=document.getElementById("gameCenterMessage");if(g&&(g.innerHTML=`<span class="game-center-highlight">${u}</span>번 접시에 토큰 1개를 더 놓았습니다`),document.querySelectorAll("#gamePlateRing .game-plate").forEach(I=>I.classList.remove("game-plate--placeable")),setTimeout(()=>{ee(t,{0:o,1:c})},200),D){const[I,w]=D,B=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${I}"]`),b=document.querySelector(`#gamePlateRing .game-plate-lid[data-plate-index="${w}"]`),R=S=>{S&&(S.classList.remove("game-plate-lid--uncover"),S.classList.remove("game-plate-lid--covered"),S.offsetHeight,S.classList.add("game-plate-lid--covered"))};setTimeout(()=>{R(B),R(b)},400),D=null}};l.on("game:mainTokenPlaced",Ke);const Pe=e=>{const n=e;if(n?.roomId!==a.roomId)return;p=n.currentTurn===0||n.currentTurn===1?n.currentTurn:p,document.getElementById("roomPlayers")?.querySelectorAll(".player-slot")?.forEach((c,m)=>{c.classList.toggle("player-slot--turn",x==="playing"&&m===p)}),G&&j==="main"?setTimeout(()=>Y(),K):Y(),te()};l.on("game:turnSwitch",Pe);function Me(){const e=document.getElementById("gameAreaContent");if(e)if(y&&(clearInterval(y),y=null),x==="ready"){const n=ve?'<button type="button" class="game-ready-btn" id="readyBtn" disabled>Ready</button>':'<p class="game-phase-label game-phase-label--waiting" aria-live="polite">방장이 게임을 시작할 때까지 기다리는 중…</p>';e.innerHTML=`
        <p class="game-phase-label" aria-live="polite"></p>
        ${n}
      `;const t=e.querySelector("#readyBtn");t&&t.addEventListener("click",()=>{l?.emit("game:start",{roomId:a.roomId})})}else{document.getElementById("gameRoom")?.classList.add("game-room--playing"),document.getElementById("gameArea")?.classList.add("game-area--playing");const n=Ze.trim()||" ",t=X,o=Array.from({length:t},(m,r)=>{const u=360/t*r,g=r+1;return`
          <div class="game-plate" data-plate-index="${r}" style="--plate-angle: ${u}deg" role="button" tabindex="0" aria-label="접시 ${g}">
            <span class="game-plate-number" aria-hidden="true">${g}</span>
            <div class="game-plate-tokens" aria-hidden="true"></div>
          </div>
          <div class="game-plate-lid" data-plate-index="${r}" style="--plate-angle: ${u}deg" aria-hidden="true"></div>`}).join("");e.innerHTML=`
        <div class="game-plate-ring" id="gamePlateRing">
          ${o}
          <div class="game-center-zone">
            <div id="gameTimer" class="game-timer">${se($)}</div>
            <div id="gameCenterMessage" class="game-center-message">${ne(n)}</div>
          </div>
        </div>
        <div id="gameMainContent" class="game-main-content"></div>
      `;const c=e.querySelector(".game-plate-ring");c?.addEventListener("click",m=>{if(E)return;const r=m.target,u=p===a.playerIndex;if(j==="main"&&u&&!P){if(J==="placeToken"){const R=r.closest(".game-plate.game-plate--placeable");if(R){const S=R.getAttribute("data-plate-index");if(S!==null){const z=parseInt(S,10);Number.isNaN(z)||Ge(z)}return}}const b=r.closest(".game-plate-lid");if(b){const R=b.getAttribute("data-plate-index");if(R!==null){const S=parseInt(R,10);Number.isNaN(S)||Ue(S)}return}}const I=r.closest(".game-plate");if(!I)return;const w=I.getAttribute("data-plate-index");if(w===null)return;const B=parseInt(w,10);Number.isNaN(B)||ce(B)}),c?.addEventListener("keydown",m=>{if(E)return;const r=m;if(r.key!=="Enter"&&r.key!==" ")return;const u=m.target.closest(".game-plate");if(!u)return;r.preventDefault();const g=u.getAttribute("data-plate-index");if(g===null)return;const I=parseInt(g,10);Number.isNaN(I)||ce(I)}),te(),Y()}}Me();const Ae=document.getElementById("backToLobbyBtn");Ae.addEventListener("click",()=>{Ae.disabled=!0,ie({emitSocketLeave:!0,reenableBackBtn:!0})});const we=document.getElementById("gameWrap");we&&we.addEventListener("click",e=>{if(E)return;const n=e.target;x==="playing"&&p!==a.playerIndex&&(n.closest("#backToLobbyBtn")||je("본인 차례가 아닐때는 클릭할 수 없습니다"))});function Be(e){const n=document.getElementById("roomPlayers");if(!e)return;p=e.currentTurn??0,(e.firstPlayerIndex===0||e.firstPlayerIndex===1)&&(k=e.firstPlayerIndex);const t=e.player1?.name??"대기 중",o=e.player2?.name??"대기 중",c=a.playerIndex,m=n?.querySelectorAll(".player-slot");if(m&&m.length>=2){const r=[t,o];m.forEach((u,g)=>{const I=u.querySelector(".player-name"),w=u.querySelector(".player-badge");I&&(I.textContent=r[g]??"대기 중"),w&&(w.hidden=g!==c),u.classList.toggle("player-slot--me",g===c),u.classList.toggle("player-slot--turn",x==="playing"&&g===p)})}if(x==="ready"&&ve){const r=document.getElementById("readyBtn");if(r){const u=!!(e.player1&&e.player2);r.disabled=!u}}}async function Re(){const e=await Oe(a.roomId);Be(e)}Re(),N&&clearInterval(N),N=setInterval(Re,Qe)}async function ot(){await qe(),fe();const i=le(),s=He();if(!i){me();return}if(s){pe();return}re()}ot().catch(i=>console.error("[init]",i));
